generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                String             @id @default(uuid())
  username          String?            @unique
  password          String
  role              UserRole           @default(PEMINJAM)
  email             String             @unique
  no_hp             String?
  alamat            String?
  is_active         Boolean            @default(true)
  created_at        DateTime           @default(now())
  updated_at        DateTime           @updatedAt
  first_name        String
  kelas             String?
  last_name         String
  activity_logs     ActivityLog[]
  articles          Article[]
  approved_loans    Loan[]             @relation("ApprovedLoans")
  rejected_loans    Loan[]             @relation("RejectedLoans")
  loans             Loan[]
  registrationCodes RegistrationCode[]
  returns_received  Return[]           @relation("ReceivedReturns")
  returns_made      Return[]           @relation("MadeReturns")

  @@map("users")
}

model Category {
  id         String      @id @default(uuid())
  nama       String      @unique
  deskripsi  String?
  created_at DateTime    @default(now())
  updated_at DateTime    @updatedAt
  equipment  Equipment[]

  @@map("categories")
}

model Equipment {
  id          String          @id @default(uuid())
  nama        String
  kode_alat   String?         @unique
  kategori_id String
  stok        Int             @default(0)
  status      EquipmentStatus @default(AVAILABLE)
  gambar      String?
  harga_sewa  Decimal?        @db.Decimal(10, 2)
  deskripsi   String?
  created_at  DateTime        @default(now())
  updated_at  DateTime        @updatedAt
  harga_alat  Decimal?        @db.Decimal(10, 2)
  tags        String[]        @default([])
  kategori    Category        @relation(fields: [kategori_id], references: [id])
  loans       Loan[]

  @@index([kategori_id, status])
  @@index([status, stok])
  @@map("equipment")
}

model Loan {
  id                String     @id @default(uuid())
  user_id           String
  equipment_id      String
  jumlah            Int        @default(1)
  tanggal_pinjam    DateTime   @default(now())
  tanggal_kembali   DateTime?
  tanggal_deadline  DateTime
  status            LoanStatus @default(PENDING)
  denda             Decimal    @default(0) @db.Decimal(10, 2)
  keterangan        String?
  approved_by       String?
  rejected_by       String?
  rejection_reason  String?
  approved_at       DateTime?
  created_at        DateTime   @default(now())
  updated_at        DateTime   @updatedAt
  batas_waktu_ambil DateTime?
  tanggal_ambil     DateTime?
  approver          User?      @relation("ApprovedLoans", fields: [approved_by], references: [id])
  equipment         Equipment  @relation(fields: [equipment_id], references: [id])
  rejecter          User?      @relation("RejectedLoans", fields: [rejected_by], references: [id])
  user              User       @relation(fields: [user_id], references: [id])
  return            Return?

  @@index([user_id, status])
  @@index([equipment_id, status])
  @@index([status, tanggal_pinjam])
  @@index([tanggal_deadline])
  @@index([approved_by])
  @@map("loans")
}

model Return {
  id                   String          @id @default(uuid())
  loan_id              String          @unique
  returned_by          String
  received_by          String?
  tanggal_kembali      DateTime        @default(now())
  kondisi_alat         ReturnCondition
  catatan              String?
  foto_bukti           String?
  denda_dibayar        Decimal         @default(0) @db.Decimal(10, 2)
  created_at           DateTime        @default(now())
  updated_at           DateTime        @updatedAt
  denda_kerusakan      Decimal         @default(0) @db.Decimal(10, 2)
  persentase_kerusakan Decimal?        @db.Decimal(5, 2)
  confirmed_at         DateTime?
  denda_telat          Decimal         @default(0) @db.Decimal(10, 2)
  status               ReturnStatus    @default(MENUNGGU_PEMBAYARAN)
  total_denda          Decimal         @default(0) @db.Decimal(10, 2)
  loan                 Loan            @relation(fields: [loan_id], references: [id])
  receiver             User?           @relation("ReceivedReturns", fields: [received_by], references: [id])
  returner             User            @relation("MadeReturns", fields: [returned_by], references: [id])

  @@index([loan_id])
  @@index([returned_by])
  @@index([received_by])
  @@index([tanggal_kembali])
  @@index([kondisi_alat])
  @@index([status])
  @@map("returns")
}

model Article {
  id           String        @id @default(uuid())
  judul        String
  slug         String        @unique
  konten       String
  excerpt      String?
  thumbnail    String?
  tags         String[]      @default([])
  view_count   Int           @default(0)
  status       ArticleStatus @default(DRAFT)
  author_id    String
  published_at DateTime?
  created_at   DateTime      @default(now())
  updated_at   DateTime      @updatedAt
  author       User          @relation(fields: [author_id], references: [id])

  @@index([author_id])
  @@index([status])
  @@index([slug])
  @@index([published_at])
  @@index([created_at])
  @@index([view_count])
  @@map("articles")
}

model ActivityLog {
  id         String   @id @default(uuid())
  user_id    String
  action     String
  table_name String
  record_id  String
  old_data   Json?
  new_data   Json?
  ip_address String?
  user_agent String?
  created_at DateTime @default(now())
  user       User     @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id])
  @@index([table_name])
  @@index([created_at])
  @@map("activity_logs")
}

model RegistrationCode {
  id          String             @id @default(uuid())
  code        String             @unique
  keterangan  String?
  max_usage   Int                @default(0)
  used_count  Int                @default(0)
  expire_date DateTime?
  status      RegistrationStatus @default(AKTIF)
  created_by  String
  created_at  DateTime           @default(now())
  updated_at  DateTime           @updatedAt
  creator     User               @relation(fields: [created_by], references: [id])

  @@index([code])
  @@index([status])
  @@index([expire_date])
  @@index([created_by])
  @@map("registration_codes")
}

enum UserRole {
  ADMIN
  PETUGAS
  PEMINJAM
}

enum EquipmentStatus {
  AVAILABLE
  UNAVAILABLE
  MAINTENANCE
}

enum LoanStatus {
  PENDING
  APPROVED
  REJECTED
  BORROWED
  RETURNED
  OVERDUE
  EXPIRED
}

enum ReturnCondition {
  BAIK
  RUSAK_RINGAN
  RUSAK_BERAT
  HILANG
  RUSAK_SEDANG
}

enum ReturnStatus {
  MENUNGGU_PEMBAYARAN
  DIKEMBALIKAN
}

enum ArticleStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum RegistrationStatus {
  AKTIF
  NONAKTIF
  EXPIRED
}
